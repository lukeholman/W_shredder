---
title: "run_model"
author: "Luke Holman"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r}
# This bit is for the unimelb cluster, Spartan
working_directory <- "/data/projects/punim0243/W_shredder"
setwd(working_directory)
```


```{r setup, echo=FALSE, results='hide'}
source_rmd <- function(file){
  options(knitr.duplicate.label = "allow")
  tempR <- tempfile(tmpdir = ".", fileext = ".R")
  on.exit(unlink(tempR))
  knitr::purl(file, output = tempR, quiet = TRUE)
  source(tempR, local = globalenv())
}
source_rmd("analysis/model_functions.Rmd")
custom_functions <- ls()
```


## Define the parameter space, using a SLURM job
```{r}
done <- list.files("data/sim_results")
if(length(done) > 100000){
  print("Waiting to check completed files...")
  system("sbatch code/set_up_parameters.slurm")
  not_done <- TRUE
  while(not_done){
    Sys.sleep(30)
    if(file.exists("parameters_left_to_do.rds")) not_done <- FALSE
  }
  print("Files have now been checked, ready to start!")
} else {
  source("code/set_up_parameters.R")
}

parameters <- readRDS("parameters_left_to_do.rds")
print(paste("Queing up", nrow(parameters), "model runs"))
```


## Now launch lots of SLURM jobs to run the remaining parameter spaces
```{r}
chunk_size <- 400
cpus <- 1
sopt <- list(time = '48:00:00',  # time in hours
             mem  = '51200')     # 60ishGB memory across all 8 cores

chunks <- split(1:nrow(parameters),
                ceiling(seq_along(1:nrow(parameters))/chunk_size))
number_of_chunks <- length(chunks)


sjob <- slurm_apply(
  f = function(i) {
    try(do_all_parameters(parameters[chunks[[i]],], 
                          over_write = FALSE, 
                          cores = cpus,
                          wd = working_directory))
  },
  params = data.frame(i = 1:length(chunks)),
  add_objects = c("do_all_parameters", 
                  "parameters", "cpus",
                  "working_directory",
                  "chunks", "number_of_chunks",
                  custom_functions),
  jobname = 'W_shredder',
  nodes = number_of_chunks, 
  cpus_per_node = cpus, 
  slurm_options = sopt)
```

